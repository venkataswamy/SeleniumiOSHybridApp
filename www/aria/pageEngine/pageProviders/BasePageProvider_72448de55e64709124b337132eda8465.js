/*
 * Copyright Amadeus
 */
Aria.classDefinition({$classpath:"aria.pageEngine.pageProviders.BasePageProvider",$implements:["aria.pageEngine.pageProviders.PageProviderInterface"],$dependencies:["aria.core.DownloadMgr"],$constructor:function(a){this._config=a;if(!("cache"in a))a.cache=true;this._cache={};this._urlMap={pageIdToUrl:{},urlToPageId:{}}},$prototype:{loadSiteConfig:function(a){this._sendRequest(this._config.siteConfigLocation,{callback:a},"site")},loadPageDefinition:function(a,b){a=a||{};var c=this._getPageId(a);a.pageId=
c;this._updateUrlMap(a);var d=this._config.cache?this._retrieveFromCache(a):null;d?this.$callback(b.onsuccess,d):this._sendRequest(this._config.pageBaseLocation+c+".json",{pageRequest:a,callback:b},"page")},_sendRequest:function(a,b,c){a=aria.core.DownloadMgr.resolveURL(a);aria.core.IO.asyncRequest({url:a,expectedResponseType:"json",callback:{fn:c=="page"?this._onPageSuccess:this._onSiteSuccess,scope:this,args:b,onerror:this._onFailure}})},_onSiteSuccess:function(a,b){this.$callback(b.callback.onsuccess,
a.responseJSON)},_onPageSuccess:function(a,b){var c=b.callback,d=b.pageRequest,e=a.responseJSON;this._updateUrlMap(e);d=this._getUrl(d);this._config.cache&&this._updateCache(e,{url:d});e.url=d;this._updateUrlMap(e);this.$callback(c.onsuccess,e)},_onFailure:function(a,b){this.$callback(b.callback.onfailure)},_updateUrlMap:function(a){var b=a.pageId,c=a.url;a=this._urlMap;if(b&&c){a.pageIdToUrl[b]=c;a.urlToPageId[c]=b;c=c.replace(/\/$/,"");a.urlToPageId[c]=b}},_retrieveFromCache:function(a){var b=this._getPageId(a);
if(b&&this._cache[b]){b=this._cache[b];b.url=this._getUrl(a);return b}return null},_getPageId:function(a){var b=this._urlMap.urlToPageId,c=a.pageId;a=a.url;if(c)return c;if(a)if(b=b[a]||b[a+"/"]||b[a.replace(/\/$/,"")])return b;return this._config.homePageId},_getUrl:function(a){var b=this._urlMap.pageIdToUrl,c=a.pageId;if(a=a.url)return a;if(c&&b[c])return b[c];return"/"+c},_updateCache:function(a,b){var c=b.url,d=a.url;if(d)this._cache[d]=a;this._cache[a.pageId]=a;this._cache[c]=a}}});