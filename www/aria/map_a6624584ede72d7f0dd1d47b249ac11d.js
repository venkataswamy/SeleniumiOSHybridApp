/*
 * Copyright Amadeus
 */
//***MULTI-PART
//MCylagYg2Y
//LOGICAL-PATH:aria/map/CfgBeans.js
//MCylagYg2Y
Aria.beanDefinitions({$package:"aria.map.CfgBeans",$description:"Definition of beans used for Maps",$namespaces:{json:"aria.core.JsonTypes",core:"aria.core.CfgBeans"},$beans:{MapCfg:{$type:"json:Object",$description:"Configuration object passed to a Map Provider to create a map",$properties:{id:{$type:"json:String",$description:"unique id of the map",$mandatory:true},domElement:{$type:"json:ObjectRef",$description:"HTML Element in which the map will be created",$mandatory:true},initArgs:{$type:"json:MultiTypes",
$description:"Arguments that will be used to create the actual map instance",$default:{}}}},CreateMapCfg:{$type:"MapCfg",$description:"Configuration object passed to the Map Manager to create a map",$properties:{provider:{$type:"json:String",$description:"Map provider. It can be an alias for a classpath that was already added to the MapManager, or a classpath",$mandatory:true},afterCreate:{$type:"core:Callback",$description:"Callback called after the map is created, It receives the map instance as first argument"}}}}});
//MCylagYg2Y
//LOGICAL-PATH:aria/map/MapManager.js
//MCylagYg2Y
(function(){var f={},k={},g={},e={microsoft7:"aria.map.providers.Microsoft7MapProvider"},h={},i={};Aria.classDefinition({$classpath:"aria.map.MapManager",$singleton:true,$dependencies:["aria.map.CfgBeans","aria.templates.DomElementWrapper","aria.utils.Type"],$constructor:function(){this._createdDomWrappers={}},$destructor:function(){this.destroyAllMaps();for(var a in i)i.hasOwnProperty(a)&&i[a].$dispose();e=f=i=h=this._createdDomWrappers=g=k=null},$events:{mapReady:{description:"Notifies that a certain map has been loaded",
properties:{mapId:"{String} id of the map"}},mapDestroy:{description:"Notifies that a certain map has been destroyed",properties:{mapId:"{String} id of the map"}}},$statics:{INVALID_CONFIGURATION:"Invalid configuration for creating a map\n%1",INEXISTENT_PROVIDER:"Provider %1 cannot be found",INVALID_PROVIDER:"Provider %1 is not valid",DUPLICATED_PROVIDER:"Provider %1 exists already",DUPLICATED_MAP_ID:"A map with id %1 already exists.",LOADING:"loading",READY:"ready"},$prototype:{createMap:function(a){if(this._checkCfg(a))if(g[a.id])this.$logError(this.DUPLICATED_MAP_ID,
a.id);else{g[a.id]=this.LOADING;var b=a.provider;b in e||this.addProvider(b,b);this._getProviderInstance(b,{fn:this._loadProviderDependencies,scope:this,args:a})}},getMap:function(a){return f[a]?f[a].instance:null},getMapDom:function(a){var b=this._createdDomWrappers[a];if(b)return b;if(b=k[a]){b=new aria.templates.DomElementWrapper(b);return this._createdDomWrappers[a]=b}},destroyMap:function(a){var b=f[a];if(b){h[b.providerName].disposeMap(b.instance);delete f[a];delete k[a];if(b=this._createdDomWrappers[a]){b.$dispose();
delete this._createdDomWrappers[a]}delete g[a];this.$raiseEvent({name:"mapDestroy",mapId:a})}},destroyAllMaps:function(a){var b=a&&a in e,c,d;for(d in f)if(f.hasOwnProperty(d)){c=f[d];if(!b||c.providerName==a)this.destroyMap(d)}},addProvider:function(a,b){if(e[a])this.$logError(this.DUPLICATED_PROVIDER,a);else if(aria.utils.Type.isObject(b))if(this._isValidProvider(b)){h[a]=b;e[a]=b}else this.$logError(this.INVALID_PROVIDER,a);else e[a]=b},removeProvider:function(a){this.destroyAllMaps(a);delete e[a];
if(i[a]){i[a].$dispose();delete i[a]}delete h[a]},hasProvider:function(a){return a in e},_checkCfg:function(a){try{aria.core.JsonValidator.normalize({json:a,beanName:"aria.map.CfgBeans.CreateMapCfg"},true)}catch(b){a=aria.core.Log;var c=[""];if(a)for(var d,j=0,l=b.errors.length;j<l;j+=1){d=b.errors[j];c.push(a.prepareLoggedMessage(d.msgId,d.msgArgs))}this.$logError(this.INVALID_CONFIGURATION,c.join("\n"));return false}return true},_getProviderInstance:function(a,b){h[a]?this.$callback(b):Aria.load({classes:[e[a]],
oncomplete:{fn:this._setProviderInstance,scope:this,args:{providerName:a,cb:b}},onerror:{fn:this._raiseInexistentProviderError,scope:this,args:{providerName:a,cb:b}}})},_raiseInexistentProviderError:function(a){this.$logError(this.INEXISTENT_PROVIDER,a.providerName);a=a.cb.args;delete g[a.id];(a=a.afterCreate)&&this.$callback(a,null)},_setProviderInstance:function(a){var b=a.providerName,c=Aria.getClassRef(e[b]),d=!aria.utils.Type.isFunction(c);c=d?c:new c;if(this._isValidProvider(c)){h[b]=c;d||(i[b]=
c);this.$callback(a.cb)}else{b=a.cb.args;delete g[b.id];c.$dispose();this.$logError(this.INVALID_PROVIDER,a.providerName);(a=b.afterCreate)&&this.$callback(a,null)}},_isValidProvider:function(a){for(var b=true,c=["load","getMap","disposeMap"],d=0;d<c.length;d++)b=b&&a[c[d]]&&aria.utils.Type.isFunction(a[c[d]]);return b},_loadProviderDependencies:function(a,b){h[b.provider].load({fn:this._retrieveMapInstance,scope:this,args:b})},_retrieveMapInstance:function(a,b){var c=a&&a.id&&a.provider?a:b,d=c.provider,
j=c.id,l=c.afterCreate,m=h[d].getMap(c);f[j]={instance:m,providerName:d};k[j]=c.domElement;g[j]=this.READY;l&&this.$callback(l,m);this.$raiseEvent({name:"mapReady",mapId:j})},getMapStatus:function(a){return g[a]||null}}})})();
//MCylagYg2Y
//LOGICAL-PATH:aria/embed/Map.js
//MCylagYg2Y
Aria.classDefinition({$classpath:"aria.embed.Map",$extends:"aria.embed.Element",$dependencies:["aria.embed.controllers.MapController"],$constructor:function(a){this.$Element.constructor.apply(this,arguments);this._cfg.controller=aria.embed.controllers.MapController;this._cfg.args={id:a.id,provider:a.provider,initArgs:a.initArgs,loadingIndicator:a.loadingIndicator}},$prototype:{_cfgBeanName:"aria.embed.CfgBeans.MapCfg"}});
//MCylagYg2Y
//LOGICAL-PATH:aria/embed/controllers/MapController.js
//MCylagYg2Y
(function(){var e={},f={};Aria.classDefinition({$classpath:"aria.embed.controllers.MapController",$singleton:true,$dependencies:["aria.map.MapManager","aria.utils.Json"],$constructor:function(){this.mapManager=aria.map.MapManager;this.mapManager.$addListeners({mapDestroy:{fn:this._nullifyMapDom,scope:this}});this._listeners=0},$destructor:function(){this.mapManager.$removeListeners({mapDestroy:{fn:this._nullifyMapDom,scope:this}});f=e=this.mapManager=null},$prototype:{onEmbededElementCreate:function(a,
b){var c=this.mapManager.getMapStatus(b.id),d=e[b.id];c===null?this._createMap(a,b):a.appendChild(d);c=this.mapManager.getMapStatus(b.id);b.loadingIndicator&&c!=this.mapManager.READY&&this._activateLoadingIndicator(a,b)},_createMap:function(a,b){var c=aria.utils.Json.copy(b);delete c.loadingIndicator;var d=Aria.$window.document.createElement("div");c.domElement=d;e[b.id]=d;a.appendChild(d);this.mapManager.createMap(c)},_activateLoadingIndicator:function(a,b){this._triggerLoadingIndicator(a,true);
f[b.id]={container:a};this._listeners===0&&this.mapManager.$addListeners({mapReady:{fn:this._removeLoadingIndicator,scope:this}});this._listeners++},_removeLoadingIndicator:function(a){var b=f[a.mapId];if(b){this._triggerLoadingIndicator(b.container,false);delete f[a.mapId];this._listeners--;this._listeners===0&&this.mapManager.$removeListeners({mapReady:{fn:this._removeLoadingIndicator,scope:this}})}},onEmbededElementDispose:function(a,b){var c=b.id;b.loadingIndicator&&this._triggerLoadingIndicator(a,
false);if(c=e[c]){var d=c.parentNode;d&&d.removeChild(c)}},_nullifyMapDom:function(a){delete e[a.mapId]},_triggerLoadingIndicator:function(a,b){if(a)b?aria.utils.DomOverlay.create(a):aria.utils.DomOverlay.detachFrom(a)}}})})();